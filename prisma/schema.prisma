// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @map("_id")
  name          String
  email         String
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt
  sessions      Session[]
  accounts      Account[]

  twoFactorEnabled Boolean?    @default(false)
  twofactors       TwoFactor[]
  passkeys         Passkey[]

  banned     Boolean?  @default(false)
  banReason  String?
  banExpires DateTime?

  role           String?
  companies      Company[]
  companyOwner   Company[]       @relation("CompanyOwner")
  contacts       Contact[]
  deals          Deal[]
  assignedDeals  Deal[]          @relation("AssignedDeals")
  activities     Activity[]
  aiinteractions AIInteraction[]
  notifications  Notification[]
  contactCreator Contact[]       @relation("ContactCreator")

  @@unique([email])
  @@index([emailVerified])
  @@index([banned])
  @@map("user")
}

model Session {
  id        String   @id @map("_id")
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  impersonatedBy String?

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id @map("_id")
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id @map("_id")
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model TwoFactor {
  id          String @id @map("_id")
  secret      String
  backupCodes String
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("twoFactor")
}

model Passkey {
  id           String    @id @map("_id")
  name         String?
  publicKey    String
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentialID String
  counter      Int
  deviceType   String
  backedUp     Boolean
  transports   String?
  createdAt    DateTime?
  aaguid       String?

  @@map("passkey")
}

model Company {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  domain      String? @unique
  industry    String?
  size        String?
  revenue     Float?
  location    String?
  description String?
  website     String?
  phone       String?

  linkedin       String?
  technographics Json?
  socialProfiles Json?
  firmographics  Json?

  aiScore     Float?  @default(0)
  aiInsights  Json?
  sentiment   String?
  healthScore Float?  @default(50)

  ownerId String?
  owner   User?   @relation("CompanyOwner", fields: [ownerId], references: [id])

  contacts      Contact[]
  deals         Deal[]
  activities    Activity[]
  aiPredictions AIPrediction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])

  @@index([ownerId])
  @@index([industry])
  @@index([createdAt])
  @@map("companies")
}

model Contact {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  firstName  String
  lastName   String
  email      String? @unique
  phone      String?
  title      String?
  department String?

  companyId String?  @db.ObjectId
  company   Company? @relation(fields: [companyId], references: [id])

  linkedin     String?
  twitter      String?
  photoUrl     String?
  enrichedData Json?

  engagementScore Float?    @default(0)
  lastEngagement  DateTime?
  aiInsights      Json?
  predictedIntent String?

  createdById String?
  createdBy   User?   @relation("ContactCreator", fields: [createdById], references: [id])

  deals      Deal[]
  activities Activity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?

  @@map("contacts")
}

model Deal {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  amount      Float
  stage       String
  probability Float   @default(0)

  aiProbability      Float?
  winPrediction      Float?
  riskScore          Float?
  predictedCloseDate DateTime?
  nextBestAction     String?

  companyId String?  @db.ObjectId
  company   Company? @relation(fields: [companyId], references: [id])

  primaryContactId String?  @db.ObjectId
  primaryContact   Contact? @relation(fields: [primaryContactId], references: [id])

  assignedToId String?
  assignedTo   User?   @relation("AssignedDeals", fields: [assignedToId], references: [id])

  expectedCloseDate DateTime?
  actualCloseDate   DateTime?

  activities    Activity[]
  aiPredictions AIPrediction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?

  @@map("deals")
}

model Activity {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  type        String
  subject     String
  description String?

  sentiment       String?
  summary         String?
  extractedTopics String[] // AI-extracted topics
  actionItems     Json?

  companyId String?  @db.ObjectId
  company   Company? @relation(fields: [companyId], references: [id])

  contactId String?  @db.ObjectId
  contact   Contact? @relation(fields: [contactId], references: [id])

  dealId String? @db.ObjectId
  deal   Deal?   @relation(fields: [dealId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  scheduledAt DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("activities")
}

model AIPrediction {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  type       String
  model      String
  confidence Float
  prediction Json
  factors    Json?

  companyId String?  @db.ObjectId
  company   Company? @relation(fields: [companyId], references: [id])

  dealId String? @db.ObjectId
  deal   Deal?   @relation(fields: [dealId], references: [id])

  createdAt DateTime  @default(now())
  expiresAt DateTime?

  @@map("ai_predictions")
}

model AIInteraction {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  type     String
  prompt   String
  response Json
  model    String
  tokens   Int?
  cost     Float?

  userId String
  user   User   @relation(fields: [userId], references: [id])

  context  Json?
  feedback String?

  createdAt DateTime @default(now())

  @@map("ai_interactions")
}

model Notification {
  id       String  @id @default(auto()) @map("_id") @db.ObjectId
  type     String
  title    String
  message  String
  priority String  @default("normal")
  read     Boolean @default(false)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  metadata  Json?
  createdAt DateTime @default(now())

  @@map("notifications")
}
